<!DOCTYPE html>
<html style="width:100%;height:100%;">
<head>
  <title>Top 250 Movies Visualization</title>
  <script src="https://d3js.org/d3.v3.min.js"></script>
      <script src="https://d3js.org/d3-queue.v3.min.js"></script>

  <script src="fisheye.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Lato|Libre+Baskerville" rel="stylesheet">
  <link rel = "stylesheet" type = "text/css" href = "style_kl.css" />
</head>
<body style="width:100%;height:100%;margin:0;">
  <svg id="revenue-graph" height="100%" width="100%">
    <text id="title" x="825" y="70" text-anchor="middle" font-size="50">Top 100 IMDB Movies</text>
    <text class="overview" x="825" y="100" text-anchor="middle">We examined the top 100 rated movies on IMDB </text>
    <text class="overview" x="825" y="120" text-anchor="middle">for revenue in order of rating and time.</text>

    <foreignobject class="infobox" x="560" y="135" width="800" height="300">
      <div class="mainInfo">
        <div class="row">
          <div class="column left ">
          <img id="moviePoster" src="http://www.backgroundsbymaheu.com/_resources/common/products/full/thumb.aspx?src=kelly+dark+gray%2Ejpg&width=350&crop=false" alt="Movie Poster" style="height:110px; width:75px;">
          </div>
          <div class="column middle">
            <table>
              <tr>
                <th>Title:</th>
                <td id="movieTitle">Movie Title</td>
              </tr>
              <tr>
                <th>Director:</th>
                <td id="movieDirector">Director</td>
              </tr>
              <tr>
                <th>Year:</th>
                <td id="movieYear">Year</td>
              </tr>
              <tr>
                <th>Rating:</th>
                <td id="movieRating">Rating</td>
              </tr>
              <tr>
              <th>Ranking:</th>
              <td id="movieRanking">Ranking</td>
            </tr>
            </table>
          </div>
        <div class="column right">
          <table>
            <tr>
              <th>Genre:</th>
              <td id="movieGenre">Genre</td>
            </tr>
            <tr>
              <th>Budget:</th>
              <td id="movieBudget">Budget</td>
            </tr>
            <tr>
              <th>Gross:</th>
              <td id="movieGross">Gross</td>
            </tr>
            <!-- <tr>
              <th>Summary:</th>
              <td id="movieSummary">
                <br>
                <br><br><br><br><br>
              </td>
            </tr> -->

          </table>
        </div>
      </div>
    </div>

    </foreignobject>
  </svg>
<script>

//Calculates a movies inflation-adjusted gross, in 2018 dollars
function calculateInflation(d, _ticketMap) {
    //Divide movie's original revenue by the average ticket price in the year it was released
    originalYear = d.Year

    //if year does not exist in ticket price lookup table
    //set it to the price of ticket in 1929
    if( ! _ticketMap.get(String(originalYear)).avg_ticket) {
        num_tickets_sold = d.Revenue / _ticketMap.get(String(1929)).avg_ticket
    } else {
    num_tickets_sold = d.Revenue / _ticketMap.get(String(originalYear)).avg_ticket
    }
    //this is now an estimate of how many tickets were sold
    //multiply this number by the cost of a ticket in 2018.
    ticket_2018  = _ticketMap.get("2018").avg_ticket
    adjusted_revenue = num_tickets_sold * ticket_2018;

    return adjusted_revenue;
}
//Prepares the raw ImDB data scraped from webpages.
function mutateRow(row) {

  row["Date"] = new Date(row["Date"]);

  var revenue;
  if(row["Gross"]=="N/A"){
    revenue = 0;
  }
  else{
    //format the dollar amount into a nice number
    revenue = Number(row["Gross"].replace("$",'').replace(/,/g,"").replace(/ /g,""));
  }
  row["Revenue"] = revenue;
  row["Rating"] = Number(row["Rating"]);

  if(row["Gross"=="N/A"]){
    row["Adjusted"] = 0;
  }
  else{
    var originalYear = String(row["Year"]);
    // console.log(originalYear);
    // console.log(revenue);
    // console.log(ticketMap.get(originalYear));
    if( ticketMap.get(originalYear)==undefined) {
        num_tickets_sold = revenue / ticketMap.get(String(1929)).avg_ticket


    } else {
      num_tickets_sold = revenue / ticketMap.get(String(originalYear)).avg_ticket
    };
    row["Tickets"] = num_tickets_sold;
    // console.log(num_tickets_sold);
    ticket_2018  = ticketMap.get("2018").avg_ticket;
    adjusted_revenue = num_tickets_sold * ticket_2018;
    row["Adjusted"]=adjusted_revenue;
  };
  row["Year"] = Number(row["Year"]);
  // console.log(row);

   return row;
}
 //Prepares the average ticket price data.
  function mutateRowToo(row) {
      row["Year"] = Number(row["Year"]);
      row["avg_ticket"] = Number(row["avg_ticket"].replace("$",'').replace(/,/g,"").replace(/ /g,""));
      // console.log(row);

      return row;
  }
var data;
var ticketData;
var ticketMap;

function callback(error, movieData){
  data=movieData.filter(function (d){return d.Gross!="N/A" && d.Budget!="N/A";});
  data=data.slice(0,250);
  plot();
}

function plot(){

    //SVG formatting and setup
    var height = 750;
    var width = 1500;
    var vert_padding = 70;
    var horz_padding = 150;
    var translate = function (x, y) { return "translate(" + x + "," + y + ")"; };

    //creating svg, setting origin according to padding
    var svg = d3.select("#revenue-graph")
    .attr("height", height + 2 * vert_padding)
    .attr("width", width + 2 * horz_padding)
    .attr("padding", "3px")
    .append("g").attr("transform", translate(horz_padding,vert_padding));

    //background for mouse move
    svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height);

    var startDate = new Date(1900,01,01);
    var endDate = Date.now();
    //setting up scales
    var xScale = d3.time.scale()
    .domain([startDate, endDate])
    .range([0, width]);
    // console.log(startDate, endDate);
    var xScaleFishEye = d3.fisheye.scale(d3.time.scale)
    .domain([startDate, endDate])
    .range([0, width]).focus(90).distortion(5);
    var yScale = d3.scale.linear()
    .domain([1, 1.3*d3.max(data, function(d) { return d.Revenue; })])
    .range([height, 0]);
    //     var yScale = d3.scale.log()
    // .domain([1, 100000*d3.max(data, function(d) { return d.Revenue; })])
    // .range([height, 0]);
    var greenScale = d3.scale.log().domain([1,100])
      .interpolate(d3.interpolateHcl)
      .range([d3.rgb("#90ee90"), d3.rgb('#013220')]);
    var redScale = d3.scale.linear().domain([1,0])
      .interpolate(d3.interpolateHcl)
      .range([d3.rgb("#FFA1A1"), d3.rgb('#E80C0C')]);
    var circleScale = d3.scale.sqrt().domain([1, 100]).range([5,30]);

    //setting up axes
    var xAxis = d3.svg.axis().scale(xScaleFishEye).orient("bottom");
    var yAxis = d3.svg.axis().scale(yScale).orient("left").tickFormat(d3.format("$,"));;

    //Adding axes to svg
    svg.append("g")
    .attr("transform", translate(0,height))
    .attr("class", "x axis")
    .call(xAxis);
    svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);

    //gridlines
    svg.selectAll("line.horizontalGrid").data(yScale.ticks(7)).enter()
    .append("line")
        .attr(
        {
            "class":"horizontalGrid",
            "x1" : 0,
            "x2" : width,
            "y1" : function(d){ return yScale(d);},
            "y2" : function(d){ return yScale(d);},
            "fill" : "none",
            "shape-rendering" : "crispEdges",
            "stroke" : "black",
            "stroke-width" : "1px",
            "stroke-opacity" : ".2",
            "stroke-dasharray":"5,5"
        });

    var xLine = svg.selectAll(".x")
      .data(data)
      .enter().append("rect")
      .attr("class", "x")
      .attr("transform", function(d) { return translate(-1, yScale(d.Revenue)); })
      .attr("x", (d) => xScale(d.Date))
      .attr("width",8)
      .attr("height", (d) => height-yScale(d.Revenue))
      .attr("fill", function (d) {
        var budget = (d.Budget.replace(/,|\$/g, ''))
        var gross = (d.Gross.replace(/,|\$/g, ''))
        if(gross/budget>=1){
          return greenScale(gross/budget);
        }
        else {
          return redScale(gross/budget);
        }})
      .on("mouseover", function (d) {
        d3.select("#movieTitle").text(d.Title)
        d3.select("#movieDirector").text(d.Director)
        d3.select("#movieRating").text(d.Rating)
        d3.select("#movieYear").text(d.Year)
        d3.select("#movieSummary").text(d.Summary)
        d3.select("#movieGenre").text(d.Genre)
        d3.select("#movieBudget").text(d.Budget)
        d3.select("#movieGross").text(d.Gross)
        d3.select("#movieRanking").text(d.Ranking)
        document.getElementById("moviePoster").src = d.Small_Poster
      });


    // var circles = svg.selectAll(".circle")
    // .data(data)
    // .enter().append("circle")
    // .attr("cx", (d) => xScale(d.Date))
    // .attr("r", function (d) {
    //   var budget = (d.Budget.replace(/,|\$/g, ''))
    //   var gross = (d.Gross.replace(/,|\$/g, ''))
    //   if(!Number.isNaN(gross/budget)){
    //     return circleScale(gross/budget);
    //   }
    //   else return 0;})
    // .attr("cy", d => yScale(d.Revenue))//function(d) { return height - yScale(d.Revenue); })
    // .attr("fill", function (d) {
    //   var budget = (d.Budget.replace(/,|\$/g, ''))
    //   var gross = (d.Gross.replace(/,|\$/g, ''))
    //   if(gross/budget>=1){
    //     return greenScale(gross/budget);
    //   }
    //   else {
    //     // console.log(gross/budget);
    //     // console.log(d);
    //     return redScale(gross/budget);
    //   }})
    // // .style("opacity", .3)
    // // .style("fill", "#489075")
    // .on("mouseover", function (d) {
    //   d3.select("#movieTitle").text(d.Title)
    //   d3.select("#movieDirector").text(d.Director)
    //   d3.select("#movieRating").text(d.Rating)
    //   d3.select("#movieYear").text(d.Year)
    //   d3.select("#movieSummary").text(d.Summary)
    //   d3.select("#movieGenre").text(d.Genre)
    //   d3.select("#movieBudget").text(d.Budget)
    //   d3.select("#movieGross").text(d.Gross)
    //   document.getElementById("moviePoster").src = d.Small_Poster
    // });

    // redraw();

    svg.on("mousemove", function() {
      var mouse = d3.mouse(this);
      // console.log(mouse);
      xScaleFishEye.focus(mouse[0]);
      redraw();
    });

    function redraw() {
      xLine.attr("x", d =>xScaleFishEye(d.Date));
      // circles.attr("cx", d =>xScaleFishEye(d.Date));
      svg.select(".x.axis").call(xAxis);
    }


}
d3.tsv("ticket_inflation.txt",mutateRowToo,function(error, tdata){
  ticketData = tdata;
  ticketMap = d3.map(ticketData, function(d) {return d.Year ; });
  d3.csv("data.csv", mutateRow, callback);

});
// d3.csv("data.csv", mutateRow, callback);
// d3.queue()
//     .defer(d3.tsv, "ticket_inflation.txt", mutateRowToo)
//     .defer(d3.csv, "data.csv", mutateRow)
//     .await(callback);

</script>

</body>
</html>
